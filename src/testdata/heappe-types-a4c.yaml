tosca_definitions_version: alien_dsl_2_0_0

metadata:
  template_name: heappe-types
  template_version: 0.1.0
  template_author: yorc

imports:
  - tosca-normative-types:1.0.0-ALIEN20
  - alien-base-types:2.2.0-SM9
  - docker-types:2.2.0-SM9
  - yorc-types:1.1.0

data_types:
  org.heappe.types.CommandTemplateParameterValue:
    derived_from: tosca.datatypes.Root
    properties:
      commandParameterIdentifier:
        description: Command parameter identifier
        type: string
        required: true
      parameterValue:
        description: Command parameter value
        type: string
  org.heappe.types.EnvironmentVariable:
    derived_from: tosca.datatypes.Root
    properties:
      name:
        description: Environment variable name
        type: string
        required: true
      value:
        description: Environment variable value
        type: string
  org.heappe.types.TaskSpecification:
    derived_from: tosca.datatypes.Root
    properties:
      name:
        description: Task name
        type: string
        required: true
      commandTemplateId:
        description: Command template ID
        type: string
        required: true
      templateParameterValues:
        description: Command template parameters
        type: list
        entry_schema:
          type: org.heappe.types.CommandTemplateParameterValue
        required: false
      environmentVariables:
        description: Environment variables
        type: list
        entry_schema:
          type: org.heappe.types.EnvironmentVariable
        required: false
      minCores:
        description: Minimum number of cores required
        type: integer
        default: 1
      maxCores:
        description: Maximum number of cores required
        type: integer
        default: 1
      walltimeLimit:
        description: Maximum time for the task to run (in seconds)
        type: integer
        default: 600
      standardOutputFile:
        type: string
        default: "console_Stdout"
      standardErrorFile:
        type: string
        default: "console_Stderr"
      progressFile:
        type: string
        default: "console_Stdprog"
      logFile:
        type: string
        default: "console_Stdlog"
  org.heappe.types.JobSpecification:
    derived_from: tosca.datatypes.Root
    properties:
      name:
        description: Job name
        type: string
        required: true
      project:
        description: Accounting project
        type: string
        required: true
      clusterNodeTypeId :
        description: Cluster node type
        type: integer
        required: true
      tasks :
        description: Tasks (at leat one task needs to be defined)
        type: list
        entry_schema:
          type: org.heappe.types.TaskSpecification
        required: true
      priority:
        description: Job priority
        type: integer
        default: 4
      minCores:
        description: Minimum number of cores required
        type: integer
        default: 1
      maxCores:
        description: Maximum number of cores required
        type: integer
        default: 1
      waitingLimit:
        description: Limit for the waiting time in cluster queue (seconds)
        type: integer
        default: 600
      walltimeLimit:
        description: Maximum time for the job to run (in seconds)
        type: integer
        default: 600
artifact_types:
  org.heappe.artifacts.Deployment:
    derived_from: tosca.artifacts.Deployment
node_types:
  org.heappe.nodes.pub.Job:
    derived_from: org.alien4cloud.nodes.Job
    abstract: true
    description: >
      HEAppE Job (abstract)
    properties:
      jobSpecification:
        description: Specification of the job to create
        type: org.heappe.types.JobSpecification
        required: true
    attributes:
      job_id:
        type: string
        description: >
          ID of the HEAppE job created
    capabilities:
      heappejob:
        type: org.heappe.capabilities.HeappeJob
    interfaces:
      Standard:
        create:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
        delete:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
      tosca.interfaces.node.lifecycle.Runnable:
        submit:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
        run:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
        cancel:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
  org.heappe.nodes.Job:
    derived_from: org.heappe.nodes.pub.Job
    description: >
      HEAppE Job
  org.heappe.nodes.pub.SendDataset:
    derived_from: tosca.nodes.Root
    abstract: true
    description: >
      Transfer a dataset to a HEAppEJob input files directory (abstract)
    artifacts:
      - dataset:
          type: tosca.artifacts.File
          file: heappe-types-a4c.yaml
    requirements:
      - job:
          capability: org.heappe.capabilities.HeappeJob
          node: org.heappe.nodes.pub.Job
          relationship: org.heappe.relationships.DependsOnJob
          occurrences: [1, 1]
    interfaces:
      Standard:
        create:
          inputs:
            JOB_ID: { get_attribute: [REQ_TARGET, job, job_id] }
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
        delete:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
  org.heappe.nodes.SendDataset:
    derived_from: org.heappe.nodes.pub.SendDataset
    description: >
      Transfer a dataset to a HEAppEJob input files directory

  org.heappe.nodes.pub.GetResultFiles:
    derived_from: tosca.nodes.Root
    abstract: true
    description: >
      Get result files from a HEAppEJob (abstract) 
    properties:
      zip_result:
        type: string
        description: >
          Name of Zip file containing results files retrieved from the job
    requirements:
      - job:
          capability: org.heappe.capabilities.HeappeJob
          node: org.heappe.nodes.Job
          relationship: org.heappe.relationships.DependsOnJob
          occurrences: [1, 1]
    interfaces:
      Standard:
        create:
          inputs:
            JOB_ID: { get_attribute: [REQ_TARGET, job, job_id] }
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
        delete:
          implementation:
            file: heappe-types-a4c.yaml
            type: tosca.artifacts.Deployment.Image.Container.Docker
  org.heappe.nodes.GetResultFiles:
    derived_from: org.heappe.nodes.pub.GetResultFiles
    description: >
      Get result files from a HEAppEJob

capability_types:
  org.heappe.capabilities.HeappeJob:
    derived_from: tosca.capabilities.Root
    description: >
      A capability fulfilling requirements of a node requiring to be
      associated with a HEAppE Job.
relationship_types:
  org.heappe.relationships.DependsOnJob:
    derived_from: tosca.relationships.DependsOn
    description: Relationship between a component and a HEAppE job
    valid_target_types: [ org.heappe.nodes.pub.Job ]
